<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Metric Assessment Unit v2.5</title>
    <style>
        :root {
            --bg-color: #0a0a0a;
            --card-bg: #111111;
            --text-primary: #e5e5e5;
            --text-muted: #666666;
            --border: #333333;
            --accent: #ffffff;
            --font-main: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            --font-mono: 'JetBrains Mono', 'Courier New', monospace;

            /* Signal Colors */
            --val-1: #ff0000;
            --val-2: #ff9900;
            --val-3: #525252;
            --val-4: #c8ff00;
            --val-5: #00ff0d;
        }

        * {
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-main);
            background-color: var(--bg-color);
            color: var(--text-primary);
            margin: 0;
            padding: 0;
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .container {
            width: 100%;
            max-width: 800px;
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            height: 100%;
            position: relative;
        }

        /* --- PROGRESS BAR --- */
        .progress-bar-container {
            width: 100%;
            height: 2px;
            background-color: #222;
            position: fixed;
            top: 0;
            left: 0;
            z-index: 100;
        }

        .progress-bar {
            height: 100%;
            background-color: var(--text-primary);
            transition: width 0.3s ease;
        }

        /* --- TYPOGRAPHY --- */
        .bionic-bold {
            font-weight: 800;
            color: #ffffff;
        }

        h1,
        h2,
        h3 {
            font-weight: 400;
            margin: 0;
        }

        /* --- QUESTION VIEW --- */
        #question-view {
            display: flex;
            flex-direction: column;
            justify-content: center;
            height: 100%;
            max-width: 600px;
            margin: 0 auto;
            width: 100%;
        }

        .question-meta {
            font-family: var(--font-mono);
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-bottom: 1.5rem;
            text-align: right;
            letter-spacing: 1px;
        }

        .question-text {
            font-size: 1.4rem;
            margin-bottom: 2.5rem;
            text-align: left;
            line-height: 1.5;
            min-height: 3.5em;
            font-weight: 300;
            letter-spacing: -0.01em;
        }

        @media (min-width: 768px) {
            .question-text {
                font-size: 1.8rem;
            }
        }

        /* --- INPUT GRID --- */
        .input-group {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 1px;
            background-color: var(--border);
            border: 1px solid var(--border);
            margin-bottom: 2rem;
        }

        .input-rect {
            height: 60px;
            background-color: var(--card-bg);
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: background-color 0.1s;
            position: relative;
        }

        @media (min-width: 768px) {
            .input-rect {
                height: 80px;
            }
        }

        .input-rect:hover {
            background-color: #1a1a1a;
        }

        .input-rect.selected {
            background-color: #222;
            box-shadow: inset 0 -2px 0 var(--text-primary);
        }

        .dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
        }

        /* --- NAVIGATION --- */
        .nav-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            height: 40px;
        }

        .nav-btn {
            background: none;
            border: 1px solid transparent;
            color: var(--text-muted);
            cursor: pointer;
            font-family: var(--font-mono);
            font-size: 0.75rem;
            text-transform: uppercase;
            padding: 0.5rem 1rem;
            transition: all 0.2s;
        }

        .nav-btn:hover {
            color: var(--text-primary);
            border-color: var(--border);
        }

        .jump-btn {
            color: var(--text-primary);
            border: 1px solid var(--border);
        }

        /* --- RESULTS VIEW --- */
        #results-view {
            display: none;
            width: 100%;
            height: 100%;
            overflow-y: auto;
            padding-bottom: 4rem;
            /* Space for scroll */
        }

        .results-container {
            display: flex;
            flex-direction: column;
            gap: 2rem;
            padding-top: 1rem;
        }

        /* Header Section */
        .result-header {
            border-bottom: 1px solid var(--border);
            padding-bottom: 1.5rem;
            text-align: center;
        }

        .designation-label {
            font-family: var(--font-mono);
            font-size: 0.7rem;
            color: var(--text-muted);
            letter-spacing: 2px;
            margin-bottom: 0.5rem;
            text-transform: uppercase;
        }

        .archetype-code {
            font-family: var(--font-mono);
            color: var(--text-primary);
            font-size: 2.5rem;
            font-weight: 700;
            letter-spacing: -1px;
            line-height: 1.1;
            margin-bottom: 0.5rem;
        }

        .archetype-detailed {
            font-family: var(--font-mono);
            font-size: 0.8rem;
            color: var(--text-muted);
            cursor: pointer;
            display: inline-block;
            padding: 8px 12px;
            border: 1px solid var(--border);
            transition: all 0.2s;
            margin-top: 10px;
            text-transform: uppercase;
        }

        .archetype-detailed:hover {
            color: var(--text-primary);
            background: #111;
            border-color: var(--text-primary);
        }

        .archetype-summary {
            font-size: 0.9rem;
            line-height: 1.6;
            color: #ccc;
            margin-top: 1.5rem;
            padding: 1rem;
            background: #111;
            border-left: 2px solid var(--text-primary);
            text-align: left;
        }

        /* Info Box (SLOAN) */
        #sloan-info {
            display: none;
            text-align: left;
            background: #0f0f0f;
            padding: 1.5rem;
            margin-top: 1rem;
            border: 1px solid var(--border);
            font-size: 0.8rem;
            font-family: var(--font-mono);
            color: #888;
        }

        #sloan-info h3 {
            color: var(--text-primary);
            font-size: 0.8rem;
            margin-bottom: 1rem;
            border-bottom: 1px solid #333;
            padding-bottom: 0.5rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .info-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 2rem;
        }

        @media (min-width: 700px) {
            .info-grid {
                grid-template-columns: 1fr 1fr;
            }
        }

        .info-column p {
            color: var(--text-primary);
            font-weight: bold;
            margin-top: 0;
            margin-bottom: 10px;
            font-size: 0.75rem;
            text-transform: uppercase;
        }

        /* Complex Code Display in Expanded View */
        #complex-code-display {
            font-family: var(--font-mono);
            font-size: 1.8rem;
            font-weight: 700;
            color: #fff;
            margin-bottom: 1.5rem;
            padding-bottom: 1.5rem;
            border-bottom: 1px solid #333;
            letter-spacing: 1px;
        }

        .user-breakdown-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .user-breakdown-list li {
            margin-bottom: 8px;
            padding-bottom: 8px;
            border-bottom: 1px solid #222;
            display: flex;
            flex-direction: column;
        }

        .ub-letter {
            color: #fff;
            font-weight: bold;
            font-size: 1rem;
        }

        .ub-desc {
            color: #888;
            font-size: 0.75rem;
        }

        /* Legend Tables */
        .legend-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.7rem;
            margin-bottom: 1rem;
        }

        .legend-table td {
            border: 1px solid #333;
            padding: 6px;
            text-align: center;
            color: #aaa;
        }

        .legend-table .sym {
            color: #fff;
            font-size: 1.2rem;
            width: 30px;
            font-weight: 300;
        }

        /* Data Grid Layout */
        .data-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 2rem;
        }

        @media (min-width: 768px) {
            .data-grid {
                grid-template-columns: 1fr 1fr;
                align-items: start;
            }
        }

        /* Chart Container */
        .chart-wrapper {
            background: var(--card-bg);
            border: 1px solid var(--border);
            padding: 1rem;
            display: flex;
            justify-content: center;
            align-items: center;
            aspect-ratio: 1 / 1;
        }

        canvas {
            width: 100% !important;
            height: auto !important;
            max-width: 400px;
        }

        /* Score Bars */
        .score-section-title {
            font-family: var(--font-mono);
            font-size: 0.7rem;
            color: var(--text-muted);
            text-transform: uppercase;
            margin-bottom: 1rem;
            border-bottom: 1px solid #222;
            padding-bottom: 0.25rem;
        }

        .score-block {
            margin-bottom: 0.8rem;
        }

        .score-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.3rem;
            font-family: var(--font-mono);
            font-size: 0.75rem;
        }

        .score-name {
            color: #ccc;
        }

        .score-val {
            color: var(--text-primary);
            font-weight: bold;
        }

        .score-track {
            width: 100%;
            height: 6px;
            background: #1a1a1a;
            border: 1px solid #333;
            position: relative;
        }

        .score-fill {
            height: 100%;
            background: var(--text-primary);
            transition: width 1s cubic-bezier(0.22, 1, 0.36, 1);
        }

        /* Continue Button */
        .continue-btn {
            width: 100%;
            background: var(--text-primary);
            border: 1px solid var(--text-primary);
            color: var(--bg-color);
            padding: 1rem;
            font-family: var(--font-mono);
            font-size: 0.9rem;
            font-weight: 700;
            cursor: pointer;
            text-transform: uppercase;
            transition: all 0.2s;
            margin-top: 2rem;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
        }

        .continue-btn:hover {
            background: #fff;
            box-shadow: 0 0 15px rgba(255, 255, 255, 0.3);
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 4px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-color);
        }

        ::-webkit-scrollbar-thumb {
            background: #333;
        }
    </style>
</head>

<body>

    <div class="progress-bar-container">
        <div class="progress-bar" id="progress-bar" style="width: 0%"></div>
    </div>

    <div class="container">
        <!-- Question View -->
        <div id="question-view">
            <div class="question-meta">
                <span id="question-counter">INITIALIZING...</span>
            </div>

            <div class="question-text" id="question-text"></div>

            <div class="input-group">
                <div class="input-rect" onclick="handleInput(1)" data-val="1">
                    <div class="dot" style="background-color: var(--val-1);"></div>
                </div>
                <div class="input-rect" onclick="handleInput(2)" data-val="2">
                    <div class="dot" style="background-color: var(--val-2);"></div>
                </div>
                <div class="input-rect" onclick="handleInput(3)" data-val="3">
                    <div class="dot" style="background-color: var(--val-3);"></div>
                </div>
                <div class="input-rect" onclick="handleInput(4)" data-val="4">
                    <div class="dot" style="background-color: var(--val-4);"></div>
                </div>
                <div class="input-rect" onclick="handleInput(5)" data-val="5">
                    <div class="dot" style="background-color: var(--val-5);"></div>
                </div>
            </div>

            <div class="nav-controls">
                <button class="nav-btn" id="back-btn" onclick="prevQuestion()" style="visibility: hidden;">[ PREV
                    ]</button>
                <button class="nav-btn jump-btn" id="jump-btn" onclick="jumpToFurthest()" style="display: none;">[
                    RETURN ]</button>
            </div>
        </div>

        <!-- Results View -->
        <div id="results-view">
            <div class="results-container">

                <!-- Header -->
                <div class="result-header">
                    <div class="designation-label">Your Designation</div>
                    <div class="archetype-code" id="archetype-code">CALCULATING</div>
                    <div class="archetype-detailed" id="archetype-detailed" onclick="toggleSloanInfo()">[ EXPAND
                        DESIGNATION ANALYSIS ]</div>

                    <div id="sloan-info">
                        <div class="info-grid">
                            <!-- Left Column: User Specifics -->
                            <div class="info-column">
                                <p>Your Configuration</p>
                                <div id="complex-code-display"></div>
                                <ul class="user-breakdown-list" id="user-breakdown">
                                    <!-- Populated via JS -->
                                </ul>
                            </div>

                            <!-- Right Column: Legend -->
                            <div class="info-column">
                                <p>Reference Key</p>

                                <div style="font-size: 0.7rem; color: #888; margin-bottom: 10px; line-height: 1.4;">
                                    <strong>Intensity Modifiers</strong> indicate how far your score deviates from the
                                    average.<br><br>
                                    <strong>Structural Match</strong> (the final symbol) indicates how strongly your
                                    overall profile aligns with this archetype.
                                </div>

                                <!-- Intensity Table -->
                                <table class="legend-table">
                                    <tr>
                                        <td class="sym">×</td>
                                        <td>Exceptionally High</td>
                                    </tr>
                                    <tr>
                                        <td class="sym">⁺</td>
                                        <td>Very High</td>
                                    </tr>
                                    <tr>
                                        <td class="sym">˖</td>
                                        <td>Borderline High</td>
                                    </tr>
                                    <tr>
                                        <td class="sym">￮</td>
                                        <td>Balanced</td>
                                    </tr>
                                    <tr>
                                        <td class="sym">⎻</td>
                                        <td>Borderline Low</td>
                                    </tr>
                                    <tr>
                                        <td class="sym">⎺</td>
                                        <td>Very Low</td>
                                    </tr>
                                    <tr>
                                        <td class="sym">⎽</td>
                                        <td>Exceptionally Low</td>
                                    </tr>
                                </table>

                                <!-- Structure Table -->
                                <table class="legend-table">
                                    <tr>
                                        <th colspan="3"
                                            style="border:none; padding-bottom:5px; color:#aaa; font-weight:normal;">
                                            Structural Match Strength</th>
                                    </tr>
                                    <tr>
                                        <td class="sym">▾</td>
                                        <td>Strong Match</td>
                                        <td>Balanced Profile</td>
                                    </tr>
                                    <tr>
                                        <td class="sym">▿</td>
                                        <td>Strong Match</td>
                                        <td>Uneven Profile</td>
                                    </tr>
                                    <tr>
                                        <td class="sym">●</td>
                                        <td>Fair Match</td>
                                        <td>Balanced Profile</td>
                                    </tr>
                                    <tr>
                                        <td class="sym">⚬</td>
                                        <td>Fair Match</td>
                                        <td>Uneven Profile</td>
                                    </tr>
                                    <tr>
                                        <td class="sym">￭</td>
                                        <td>Weak Match</td>
                                        <td>Balanced Profile</td>
                                    </tr>
                                    <tr>
                                        <td class="sym">⌑</td>
                                        <td>Weak Match</td>
                                        <td>Uneven Profile</td>
                                    </tr>
                                </table>
                            </div>
                        </div>
                    </div>

                    <div class="archetype-summary" id="archetype-summary"></div>
                </div>

                <!-- Data Grid -->
                <div class="data-grid">
                    <!-- Visual -->
                    <div>
                        <div class="score-section-title">Metric Visualization</div>
                        <div class="chart-wrapper">
                            <canvas id="oceanCanvas"></canvas>
                        </div>
                    </div>

                    <!-- Scores -->
                    <div>
                        <div class="score-section-title">Component Analysis</div>
                        <div id="big5-scores"></div>

                        <div class="score-section-title" style="margin-top: 2rem;">Dark Triad Indices</div>
                        <div id="dt-scores"></div>
                    </div>
                </div>

                <button class="continue-btn" onclick="redirectToForm()">
                    [ CONTINUE TO FORM ] <span>&rarr;</span>
                </button>
            </div>
        </div>
    </div>

    <script>
        // ---------------- DATA STRUCTURE ----------------
        const QUESTIONS = [
            // --- OPENNESS (10 Items) ---
            { id: 17, text: "I frequently read dense, difficult texts.", trait: "Openness", reverse: false },
            { id: 18, text: "I avoid theoretical discussions.", trait: "Openness", reverse: true },
            { id: 19, text: "I spend time visualizing abstract possibilities.", trait: "Openness", reverse: false },
            { id: 20, text: "I struggle with purely theoretical concepts.", trait: "Openness", reverse: true },
            { id: 21, text: "I am known for suggesting radical alternatives.", trait: "Openness", reverse: false },
            { id: 22, text: "I prefer established data over speculation.", trait: "Openness", reverse: true },
            { id: 23, text: "I disassemble systems to understand their core mechanics.", trait: "Openness", reverse: false },
            { id: 24, text: "I prefer to improvise rather than follow a script.", trait: "Openness", reverse: false },
            { id: 59, text: "I test unproven methods.", trait: "Openness", reverse: false },
            { id: 60, text: "I build my own tools or workflows.", trait: "Openness", reverse: false },

            // --- CONSCIENTIOUSNESS (10 Items) ---
            { id: 33, text: "I often complete work well ahead of schedule.", trait: "Conscientiousness", reverse: false },
            { id: 34, text: "I leave tools or items out of place.", trait: "Conscientiousness", reverse: true },
            { id: 35, text: "I operate on a strict timetable.", trait: "Conscientiousness", reverse: false },
            { id: 36, text: "I live in a cluttered environment.", trait: "Conscientiousness", reverse: true },
            { id: 37, text: "I am a perfectionist with every detail.", trait: "Conscientiousness", reverse: false },
            { id: 38, text: "I avoid responsibilities.", trait: "Conscientiousness", reverse: true },
            { id: 39, text: "I plan for contingencies.", trait: "Conscientiousness", reverse: false },
            { id: 40, text: "I act without a plan.", trait: "Conscientiousness", reverse: true },
            { id: 53, text: "I track my progress towards long-term goals.", trait: "Conscientiousness", reverse: false },
            { id: 54, text: "I ensure the group stays on task.", trait: "Conscientiousness", reverse: false },

            // --- EXTRAVERSION (10 Items) ---
            { id: 9, text: "I enjoy the energy of a crowd.", trait: "Extraversion", reverse: false },
            { id: 10, text: "I avoid drawing attention to myself.", trait: "Extraversion", reverse: true },
            { id: 11, text: "I am comfortable starting conversations.", trait: "Extraversion", reverse: false },
            { id: 12, text: "I keep my thoughts to myself in groups.", trait: "Extraversion", reverse: true },
            { id: 13, text: "I enjoy entertaining others.", trait: "Extraversion", reverse: false },
            { id: 14, text: "Socializing leaves me completely exhausted.", trait: "Extraversion", reverse: true },
            { id: 15, text: "I thrive in high-activity environments.", trait: "Extraversion", reverse: false },
            { id: 16, text: "I cannot focus if others are nearby.", trait: "Extraversion", reverse: true },
            { id: 61, text: "I take command in group settings.", trait: "Extraversion", reverse: false },
            { id: 62, text: "I maintain a wide network of contacts.", trait: "Extraversion", reverse: false },

            // --- AGREEABLENESS (10 Items) ---
            { id: 25, text: "I trust strangers until proven otherwise.", trait: "Agreeableness", reverse: false },
            { id: 26, text: "I can be cold and distant.", trait: "Agreeableness", reverse: true },
            { id: 27, text: "I interrupt my own workflow to help others.", trait: "Agreeableness", reverse: false },
            { id: 28, text: "I point out the faults of others.", trait: "Agreeableness", reverse: true },
            { id: 29, text: "I deflect praise to others.", trait: "Agreeableness", reverse: false },
            { id: 30, text: "I view myself as superior to my peers.", trait: "Agreeableness", reverse: true },
            { id: 31, text: "I actively campaign for universal welfare.", trait: "Agreeableness", reverse: false },
            { id: 32, text: "I enforce rules regardless of feelings.", trait: "Agreeableness", reverse: true },
            { id: 63, text: "I forgive debts or slights.", trait: "Agreeableness", reverse: false },
            { id: 64, text: "I always put the group's needs before my own ambitions.", trait: "Agreeableness", reverse: false },

            // --- NEUROTICISM (10 Items) ---
            { id: 1, text: "I experience physical symptoms of stress.", trait: "Neuroticism", reverse: false },
            { id: 2, text: "I maintain composure during crises.", trait: "Neuroticism", reverse: true },
            { id: 3, text: "I express frustration visibly.", trait: "Neuroticism", reverse: false },
            { id: 4, text: "I maintain a consistent mood.", trait: "Neuroticism", reverse: true },
            { id: 5, text: "My energy levels fluctuate unpredictably.", trait: "Neuroticism", reverse: false },
            { id: 6, text: "I remain unconcerned by uncertainty.", trait: "Neuroticism", reverse: true },
            { id: 7, text: "I suffer from physical tension.", trait: "Neuroticism", reverse: false },
            { id: 8, text: "I adapt quickly to disruptions.", trait: "Neuroticism", reverse: true },
            { id: 57, text: "I shut down when overloaded.", trait: "Neuroticism", reverse: false },
            { id: 58, text: "I function effectively under high demand.", trait: "Neuroticism", reverse: true },

            // --- DARK TRIAD (12 Items) ---
            // REVISED: Framed as "Rational/Pragmatic" to bypass ego defense mechanisms.

            // Machiavellianism: Reframed as "Strategic Realism" and "Information Control."
            { id: 41, text: "Complete transparency is a strategic error in most negotiations.", trait: "Machiavellianism", reverse: false },
            { id: 42, text: "To achieve significant goals, one must often tell people what they wish to hear.", trait: "Machiavellianism", reverse: false },
            { id: 43, text: "It is safer to assume people have hidden agendas than to trust them blindly.", trait: "Machiavellianism", reverse: false },
            { id: 44, text: "The outcome of a project is more important than the methods used to achieve it.", trait: "Machiavellianism", reverse: false },

            // Psychopathy: Focus on detachment, lack of sentiment, and risk-taking.
            { id: 45, text: "Sentimental morality often hinders necessary action.", trait: "Psychopathy", reverse: false },
            { id: 46, text: "Rules are useful guidelines for the masses, but flexible for the exceptional.", trait: "Psychopathy", reverse: false },
            { id: 47, text: "I rarely dwell on past mistakes; regret is a wasted emotion.", trait: "Psychopathy", reverse: false },
            { id: 48, text: "I can make difficult decisions without being clouded by empathy.", trait: "Psychopathy", reverse: false },

            // Narcissism: Focus on superiority, vision, and frustration with mediocrity.
            { id: 49, text: "I often feel surrounded by incompetence.", trait: "Narcissism", reverse: false },
            { id: 50, text: "My natural talents grant me the right to lead others.", trait: "Narcissism", reverse: false },
            { id: 51, text: "Society would function better if more people listened to my ideas.", trait: "Narcissism", reverse: false },
            { id: 52, text: "I require significant recognition to feel my efforts are valued.", trait: "Narcissism", reverse: false }
        ];

        // ---------------- LOGIC ----------------
        let currentQIndex = 0;
        let furthestQIndex = 0;
        const answers = new Array(QUESTIONS.length).fill(null);

        function applyBionic(text) {
            return text.split(' ').map(word => {
                const splitIndex = Math.ceil(word.length / 2);
                const boldPart = word.substring(0, splitIndex);
                const normalPart = word.substring(splitIndex);
                return `<span class="bionic-bold">${boldPart}</span>${normalPart}`;
            }).join(' ');
        }

        function renderQuestion() {
            if (currentQIndex >= QUESTIONS.length) {
                showResults();
                return;
            }

            // Update Furthest
            if (currentQIndex > furthestQIndex) furthestQIndex = currentQIndex;

            const q = QUESTIONS[currentQIndex];
            const container = document.getElementById('question-text');
            container.innerHTML = applyBionic(q.text);

            // Progress
            const progress = (currentQIndex / QUESTIONS.length) * 100;
            document.getElementById('progress-bar').style.width = `${progress}%`;
            document.getElementById('question-counter').innerText = `ITEM ${currentQIndex + 1} / ${QUESTIONS.length}`;

            // Nav Buttons
            document.getElementById('back-btn').style.visibility = currentQIndex > 0 ? 'visible' : 'hidden';

            // Jump Button Logic
            const jumpBtn = document.getElementById('jump-btn');
            if (currentQIndex < furthestQIndex) {
                jumpBtn.style.display = 'block';
                jumpBtn.innerText = `[ RETURN TO ${furthestQIndex + 1} ]`;
            } else {
                jumpBtn.style.display = 'none';
            }

            // Highlight Selected Answer
            document.querySelectorAll('.input-rect').forEach(el => {
                el.classList.remove('selected');
                if (answers[currentQIndex] !== null && parseInt(el.dataset.val) === answers[currentQIndex]) {
                    el.classList.add('selected');
                }
            });
        }

        function handleInput(val) {
            answers[currentQIndex] = val;
            currentQIndex++;
            renderQuestion();
        }

        function prevQuestion() {
            if (currentQIndex > 0) {
                currentQIndex--;
                renderQuestion();
            }
        }

        function jumpToFurthest() {
            currentQIndex = furthestQIndex;
            renderQuestion();
        }

        // ---------------- ADVANCED METRICS ----------------
        function getTraitSymbol(score) {
            // HIGH END
            if (score >= 80) return "×";  // Exceptionally High
            if (score >= 60) return "⁺";  // Very High
            if (score >= 54) return "˖";  // Borderline High

            // CENTER
            if (score >= 46) return "￮";  // Balanced

            // LOW END
            if (score >= 40) return "⎻";  // Borderline Low
            if (score >= 20) return "⎺";  // Very Low
            return "⎽";                   // Exceptionally Low
        }

        function calculateStructure(normalized) {
            const traits = ["Openness", "Conscientiousness", "Extraversion", "Agreeableness", "Neuroticism"];
            const deviations = traits.map(t => Math.abs(normalized[t] - 50));

            // SSI: Average deviation
            const ssi = deviations.reduce((a, b) => a + b, 0) / deviations.length;

            // PSI: Standard Deviation of deviations
            const meanDev = ssi;
            const variance = deviations.reduce((a, b) => a + Math.pow(b - meanDev, 2), 0) / deviations.length;
            const psi = Math.sqrt(variance);

            let strength = "";
            if (ssi >= 25) strength = "Strong";
            else if (ssi >= 15) strength = "Fair";
            else strength = "Weak";

            let symmetry = (psi < 10) ? "Even" : "Odd";

            if (strength === "Strong" && symmetry === "Even") return "▾";
            if (strength === "Strong" && symmetry === "Odd") return "▿";
            if (strength === "Fair" && symmetry === "Even") return "●";
            if (strength === "Fair" && symmetry === "Odd") return "⚬";
            if (strength === "Weak" && symmetry === "Even") return "￭";
            return "⌑";
        }

        // SLOAN Definitions
        const sloanDefs = {
            "S": { name: "Social", desc: "High Extraversion" },
            "R": { name: "Reserved", desc: "Low Extraversion" },
            "L": { name: "Limbic", desc: "High Neuroticism" },
            "C": { name: "Calm", desc: "Low Neuroticism" },
            "O": { name: "Organized", desc: "High Conscientiousness" },
            "U": { name: "Unstructured", desc: "Low Conscientiousness" },
            "A": { name: "Accommodating", desc: "High Agreeableness" },
            "E": { name: "Egocentric", desc: "Low Agreeableness" },
            "I": { name: "Inquisitive", desc: "High Openness" },
            "N": { name: "Non-curious", desc: "Low Openness" }
        };

        function showResults() {
            document.getElementById('question-view').style.display = 'none';
            document.getElementById('results-view').style.display = 'block';
            document.getElementById('progress-bar').style.width = '100%';

            const scores = calculateScores();
            const normalized = scores.normalized;

            // GENERATE SLOAN CODE
            let simpleCode = "";
            let complexCode = "";
            let traits = {};
            let userBreakdownHTML = "";

            const mapTrait = (traitName, highChar, lowChar) => {
                const val = normalized[traitName];
                const sym = getTraitSymbol(val);
                let char = "";

                if (val >= 50) {
                    char = highChar;
                    traits[highChar] = true;
                } else {
                    char = lowChar;
                    traits[lowChar] = true;
                }

                simpleCode += char;
                complexCode += char + sym;

                // Build Breakdown HTML
                const def = sloanDefs[char];
                let description = def.desc;

                // Override for Balanced Scores
                if (sym === "￮") {
                    description = `Balanced ${traitName}`;
                }

                userBreakdownHTML += `
                    <li>
                        <span class="ub-letter">${char}${sym} &nbsp; ${def.name}</span>
                        <span class="ub-desc">${description}</span>
                    </li>
                `;
            };

            mapTrait("Extraversion", "S", "R");
            mapTrait("Neuroticism", "L", "C");
            mapTrait("Conscientiousness", "O", "U");
            mapTrait("Agreeableness", "A", "E");
            mapTrait("Openness", "I", "N");

            const structSymbol = calculateStructure(normalized);

            // Main Display: Simple Code + Symbol (e.g. RLUAI●)
            document.getElementById('archetype-code').innerText = simpleCode + structSymbol;

            // Expanded Display: Complex Code + Symbol (e.g. R⎽L˖U⎺A₊I˖●)
            document.getElementById('complex-code-display').innerText = complexCode + structSymbol;

            document.getElementById('user-breakdown').innerHTML = userBreakdownHTML;
            document.getElementById('archetype-summary').innerText = generateDescription(traits);

            // Wait for layout to settle before drawing canvas
            setTimeout(() => {
                drawPentagon(normalized);
            }, 100);

            // Render Bars
            const big5HTML = ["Openness", "Conscientiousness", "Extraversion", "Agreeableness", "Neuroticism"]
                .map(t => renderScoreRow(t, normalized[t])).join('');
            document.getElementById('big5-scores').innerHTML = big5HTML;

            const dtHTML = ["Machiavellianism", "Narcissism", "Psychopathy"]
                .map(t => renderScoreRow(t, normalized[t])).join('');
            document.getElementById('dt-scores').innerHTML = dtHTML;
        }

        function generateDescription(t) {
            let desc = "Analysis of your responses indicates a specific behavioral configuration. ";
            if (t.S) desc += "You expend significant energy in social environments and prefer collective action. ";
            else desc += "You conserve energy by avoiding large groups, preferring solitary labor. ";
            if (t.L) desc += "You are highly reactive to stress and environmental instability. ";
            else desc += "You maintain a stable equilibrium and are resistant to external pressure. ";
            if (t.I) desc += "Cognitively, you prioritize theoretical concepts and novelty over tradition. ";
            else desc += "Cognitively, you prioritize established methods and concrete utility over abstraction. ";
            if (t.A) desc += "You maintain a cooperative stance, prioritizing group cohesion over personal gain. ";
            else desc += "You maintain a competitive stance, prioritizing your own leverage over the group. ";
            if (t.O) desc += "Finally, you enforce strict discipline and planning in your workflow.";
            else desc += "Finally, you utilize a flexible, spontaneous approach to task completion.";
            return desc;
        }

        function renderScoreRow(trait, score) {
            return `
            <div class="score-block">
                <div class="score-header">
                    <span class="score-name">${trait}</span>
                    <span class="score-val">${Math.round(score)}%</span>
                </div>
                <div class="score-track">
                    <div class="score-fill" style="width: ${score}%"></div>
                </div>
            </div>
        `;
        }

        function calculateScores() {
            const raw = {
                "Neuroticism": 0, "Extraversion": 0, "Openness": 0, "Agreeableness": 0, "Conscientiousness": 0,
                "Machiavellianism": 0, "Psychopathy": 0, "Narcissism": 0
            };
            const counts = {
                "Neuroticism": 0, "Extraversion": 0, "Openness": 0, "Agreeableness": 0, "Conscientiousness": 0,
                "Machiavellianism": 0, "Psychopathy": 0, "Narcissism": 0
            };

            QUESTIONS.forEach((q, i) => {
                if (raw[q.trait] !== undefined) {
                    let val = answers[i];
                    if (val === null || val === undefined) val = 3;
                    if (q.reverse) val = 6 - val;
                    raw[q.trait] += val;
                    counts[q.trait]++;
                }
            });

            const normalized = {};

            // ──────────────────────────────────────────────────────────
            // DARK TRIAD CALIBRATION
            // ──────────────────────────────────────────────────────────
            // Each DT trait's questions have different "difficulty" levels
            // due to social desirability framing. An average person responds
            // differently to each set:
            //
            //   Machiavellianism: Items sound pragmatic/rational, so average
            //     people tend to agree (~3.6/5). expectedMean = 14.5 out of 20.
            //
            //   Psychopathy: Items are more confrontational, so average people
            //     tend to mildly disagree (~2.4/5). expectedMean = 9.5 out of 20.
            //
            //   Narcissism: Moderate difficulty. Average people are near neutral
            //     but lean slightly agree (~3.25/5). expectedMean = 13 out of 20.
            //
            // We use piecewise linear normalization so that each trait's
            // expected average raw score maps to exactly 50, while 
            // preserving 0 at minimum and 100 at maximum.
            // ──────────────────────────────────────────────────────────
            const dtCalibration = {
                "Machiavellianism": 14.5,
                "Psychopathy": 9.5,
                "Narcissism": 13
            };

            for (let t in raw) {
                const count = counts[t];
                if (count === 0) {
                    normalized[t] = 0;
                    continue;
                }

                const minRaw = count;         // All 1s
                const maxRaw = count * 5;     // All 5s

                if (dtCalibration[t] !== undefined) {
                    // Piecewise linear: expectedMean → 50
                    const em = dtCalibration[t];
                    if (raw[t] <= em) {
                        normalized[t] = ((raw[t] - minRaw) / (em - minRaw)) * 50;
                    } else {
                        normalized[t] = 50 + ((raw[t] - em) / (maxRaw - em)) * 50;
                    }
                } else {
                    // Big Five: standard linear 0-100
                    normalized[t] = ((raw[t] - minRaw) / (maxRaw - minRaw)) * 100;
                }

                normalized[t] = Math.max(0, Math.min(100, normalized[t]));
            }

            return { raw, normalized };
        }

        function redirectToForm() {
            const scores = calculateScores().normalized;

            // Google Form Entry IDs
            const entryIDs = {
                "Narcissism": "1132147578",
                "Machiavellianism": "585559511",
                "Psychopathy": "1176101371",
                "Openness": "1188908959",
                "Conscientiousness": "1957203118",
                "Extraversion": "516165326",
                "Agreeableness": "672976918",
                "Neuroticism": "1986475625"
            };

            const baseUrl = "https://docs.google.com/forms/d/e/1FAIpQLSeOcyyRUkr3m0SHtZqIfsjkx3I0bUtlOf6UHcoA_Evl8_FGzA/viewform?usp=pp_url";

            let params = "";
            for (const [trait, id] of Object.entries(entryIDs)) {
                const val = Math.round(scores[trait]);
                params += `&entry.${id}=${val}`;
            }

            window.location.href = baseUrl + params;
        }

        function drawPentagon(normalizedScores) {
            const canvas = document.getElementById('oceanCanvas');
            const container = canvas.parentElement;

            // Handle High DPI
            const dpr = window.devicePixelRatio || 1;
            const rect = container.getBoundingClientRect();

            canvas.width = rect.width * dpr;
            canvas.height = rect.width * dpr; // Square aspect ratio

            const ctx = canvas.getContext('2d');
            ctx.scale(dpr, dpr);

            const width = rect.width;
            const height = rect.width;
            const cx = width / 2;
            const cy = height / 2;
            const r = (width / 2) - 30; // Padding

            ctx.clearRect(0, 0, width, height);

            // Axes
            const axes = [
                { label: "O", angle: -Math.PI / 2, val: normalizedScores["Openness"], color: "#38bdf8" },
                { label: "C", angle: -Math.PI / 2 + (2 * Math.PI / 5), val: normalizedScores["Conscientiousness"], color: "#fbbf24" },
                { label: "E", angle: -Math.PI / 2 + 2 * (2 * Math.PI / 5), val: normalizedScores["Extraversion"], color: "#f87171" },
                { label: "A", angle: -Math.PI / 2 + 3 * (2 * Math.PI / 5), val: normalizedScores["Agreeableness"], color: "#4ade80" },
                { label: "N", angle: -Math.PI / 2 + 4 * (2 * Math.PI / 5), val: normalizedScores["Neuroticism"], color: "#a78bfa" }
            ];

            // Grid
            ctx.strokeStyle = '#333';
            ctx.lineWidth = 1;
            [0.2, 0.4, 0.6, 0.8, 1].forEach(scale => {
                ctx.beginPath();
                axes.forEach((axis, i) => {
                    const x = cx + Math.cos(axis.angle) * r * scale;
                    const y = cy + Math.sin(axis.angle) * r * scale;
                    i === 0 ? ctx.moveTo(x, y) : ctx.lineTo(x, y);
                });
                ctx.closePath();
                ctx.stroke();
            });

            // Data Shape
            ctx.beginPath();
            ctx.fillStyle = 'rgba(255, 255, 255, 0.08)';
            ctx.strokeStyle = '#fff';
            ctx.lineWidth = 2;
            axes.forEach((axis, i) => {
                const val = axis.val || 0;
                const dist = (val / 100) * r;
                const x = cx + Math.cos(axis.angle) * dist;
                const y = cy + Math.sin(axis.angle) * dist;
                i === 0 ? ctx.moveTo(x, y) : ctx.lineTo(x, y);
            });
            ctx.closePath();
            ctx.fill();
            ctx.stroke();

            // Draw Points & Labels
            ctx.font = 'bold 12px JetBrains Mono';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';

            axes.forEach(axis => {
                const val = axis.val || 0;
                const dist = (val / 100) * r;
                const x = cx + Math.cos(axis.angle) * dist;
                const y = cy + Math.sin(axis.angle) * dist;

                // Point
                ctx.beginPath();
                ctx.arc(x, y, 4, 0, 2 * Math.PI);
                ctx.fillStyle = axis.color;
                ctx.fill();
                ctx.strokeStyle = '#000';
                ctx.lineWidth = 1;
                ctx.stroke();

                // Label
                const lx = cx + Math.cos(axis.angle) * (r + 20);
                const ly = cy + Math.sin(axis.angle) * (r + 20);
                ctx.fillStyle = axis.color;
                ctx.fillText(axis.label, lx, ly);
            });
        }

        function toggleSloanInfo() {
            const el = document.getElementById('sloan-info');
            const btn = document.getElementById('archetype-detailed');

            if (el.style.display === 'block') {
                el.style.display = 'none';
                btn.innerText = "[ EXPAND DESIGNATION ANALYSIS ]";
            } else {
                el.style.display = 'block';
                btn.innerText = "[ COLLAPSE ANALYSIS ]";
            }
        }

        // Init
        renderQuestion();

        // Handle Resize for Canvas
        window.addEventListener('resize', () => {
            if (document.getElementById('results-view').style.display === 'block') {
                const scores = calculateScores();
                drawPentagon(scores.normalized);
            }
        });
    </script>
</body>

</html>
