<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Metric Assessment Unit v2.5</title>
    <style>
        :root {
            --bg-color: #0a0a0a;
            --card-bg: #111111;
            --text-primary: #e5e5e5;
            --text-muted: #666666;
            --border: #333333;
            --accent: #ffffff;
            --font-main: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            --font-mono: 'JetBrains Mono', 'Courier New', monospace;

            /* Signal Colors */
            --val-1: #ff0000;
            --val-2: #ff9900;
            --val-3: #525252;
            --val-4: #c8ff00;
            --val-5: #00ff0d;
        }

        * {
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-main);
            background-color: var(--bg-color);
            color: var(--text-primary);
            margin: 0;
            padding: 0;
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .container {
            width: 100%;
            max-width: 800px;
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            height: 100%;
            position: relative;
        }

        /* --- PROGRESS BAR --- */
        .progress-bar-container {
            width: 100%;
            height: 2px;
            background-color: #222;
            position: fixed;
            top: 0;
            left: 0;
            z-index: 100;
        }

        .progress-bar {
            height: 100%;
            background-color: var(--text-primary);
            transition: width 0.3s ease;
        }

        /* --- TYPOGRAPHY --- */
        .bionic-bold {
            font-weight: 800;
            color: #ffffff;
        }

        h1,
        h2,
        h3 {
            font-weight: 400;
            margin: 0;
        }

        /* --- QUESTION VIEW --- */
        #question-view {
            display: flex;
            flex-direction: column;
            justify-content: center;
            height: 100%;
            max-width: 600px;
            margin: 0 auto;
            width: 100%;
        }

        .question-meta {
            font-family: var(--font-mono);
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-bottom: 1.5rem;
            text-align: right;
            letter-spacing: 1px;
        }

        .question-text {
            font-size: 1.4rem;
            margin-bottom: 2.5rem;
            text-align: left;
            line-height: 1.5;
            min-height: 3.5em;
            font-weight: 300;
            letter-spacing: -0.01em;
        }

        @media (min-width: 768px) {
            .question-text {
                font-size: 1.8rem;
            }
        }

        /* --- INPUT GRID --- */
        .input-group {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 1px;
            background-color: var(--border);
            border: 1px solid var(--border);
            margin-bottom: 2rem;
        }

        .input-rect {
            height: 60px;
            background-color: var(--card-bg);
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: background-color 0.1s;
            position: relative;
        }

        @media (min-width: 768px) {
            .input-rect {
                height: 80px;
            }
        }

        .input-rect:hover {
            background-color: #1a1a1a;
        }

        .input-rect.selected {
            background-color: #222;
            box-shadow: inset 0 -2px 0 var(--text-primary);
        }

        .dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
        }

        /* --- NAVIGATION --- */
        .nav-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            height: 40px;
        }

        .nav-btn {
            background: none;
            border: 1px solid transparent;
            color: var(--text-muted);
            cursor: pointer;
            font-family: var(--font-mono);
            font-size: 0.75rem;
            text-transform: uppercase;
            padding: 0.5rem 1rem;
            transition: all 0.2s;
        }

        .nav-btn:hover {
            color: var(--text-primary);
            border-color: var(--border);
        }

        .jump-btn {
            color: var(--text-primary);
            border: 1px solid var(--border);
        }

        /* --- RESULTS VIEW --- */
        #results-view {
            display: none;
            width: 100%;
            height: 100%;
            overflow-y: auto;
            padding-bottom: 4rem;
            /* Space for scroll */
        }

        .results-container {
            display: flex;
            flex-direction: column;
            gap: 2rem;
            padding-top: 1rem;
        }

        /* Header Section */
        .result-header {
            border-bottom: 1px solid var(--border);
            padding-bottom: 1.5rem;
            text-align: center;
        }

        .designation-label {
            font-family: var(--font-mono);
            font-size: 0.7rem;
            color: var(--text-muted);
            letter-spacing: 2px;
            margin-bottom: 0.5rem;
            text-transform: uppercase;
        }

        .archetype-code {
            font-family: var(--font-mono);
            color: var(--text-primary);
            font-size: 2.5rem;
            font-weight: 700;
            letter-spacing: -1px;
            line-height: 1.1;
            margin-bottom: 0.5rem;
        }

        .archetype-detailed {
            font-family: var(--font-mono);
            font-size: 0.8rem;
            color: var(--text-muted);
            cursor: pointer;
            display: inline-block;
            padding: 8px 12px;
            border: 1px solid var(--border);
            transition: all 0.2s;
            margin-top: 10px;
            text-transform: uppercase;
        }

        .archetype-detailed:hover {
            color: var(--text-primary);
            background: #111;
            border-color: var(--text-primary);
        }

        .archetype-summary {
            font-size: 0.9rem;
            line-height: 1.6;
            color: #ccc;
            margin-top: 1.5rem;
            padding: 1rem;
            background: #111;
            border-left: 2px solid var(--text-primary);
            text-align: left;
        }

        /* Info Box (SLOAN) */
        #sloan-info {
            display: none;
            text-align: left;
            background: #0f0f0f;
            padding: 1.5rem;
            margin-top: 1rem;
            border: 1px solid var(--border);
            font-size: 0.8rem;
            font-family: var(--font-mono);
            color: #888;
        }

        #sloan-info h3 {
            color: var(--text-primary);
            font-size: 0.8rem;
            margin-bottom: 1rem;
            border-bottom: 1px solid #333;
            padding-bottom: 0.5rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .info-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 2rem;
        }

        @media (min-width: 700px) {
            .info-grid {
                grid-template-columns: 1fr 1fr;
            }
        }

        .info-column p {
            color: var(--text-primary);
            font-weight: bold;
            margin-top: 0;
            margin-bottom: 10px;
            font-size: 0.75rem;
            text-transform: uppercase;
        }

        /* Complex Code Display in Expanded View */
        #complex-code-display {
            font-family: var(--font-mono);
            font-size: 1.8rem;
            font-weight: 700;
            color: #fff;
            margin-bottom: 1.5rem;
            padding-bottom: 1.5rem;
            border-bottom: 1px solid #333;
            letter-spacing: 1px;
        }

        .user-breakdown-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .user-breakdown-list li {
            margin-bottom: 8px;
            padding-bottom: 8px;
            border-bottom: 1px solid #222;
            display: flex;
            flex-direction: column;
        }

        .ub-letter {
            color: #fff;
            font-weight: bold;
            font-size: 1rem;
        }

        .ub-desc {
            color: #888;
            font-size: 0.75rem;
        }

        /* Legend Tables */
        .legend-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.7rem;
            margin-bottom: 1rem;
        }

        .legend-table td {
            border: 1px solid #333;
            padding: 6px;
            text-align: center;
            color: #aaa;
        }

        .legend-table .sym {
            color: #fff;
            font-size: 1.2rem;
            width: 30px;
            font-weight: 300;
        }

        /* Data Grid Layout */
        .data-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 2rem;
        }

        @media (min-width: 768px) {
            .data-grid {
                grid-template-columns: 1fr 1fr;
                align-items: start;
            }
        }

        /* Chart Container */
        .chart-wrapper {
            background: var(--card-bg);
            border: 1px solid var(--border);
            padding: 1rem;
            display: flex;
            justify-content: center;
            align-items: center;
            aspect-ratio: 1 / 1;
        }

        canvas {
            width: 100% !important;
            height: auto !important;
            max-width: 400px;
        }

        /* Score Bars */
        .score-section-title {
            font-family: var(--font-mono);
            font-size: 0.7rem;
            color: var(--text-muted);
            text-transform: uppercase;
            margin-bottom: 1rem;
            border-bottom: 1px solid #222;
            padding-bottom: 0.25rem;
        }

        .score-block {
            margin-bottom: 0.8rem;
        }

        .score-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.3rem;
            font-family: var(--font-mono);
            font-size: 0.75rem;
        }

        .score-name {
            color: #ccc;
        }

        .score-val {
            color: var(--text-primary);
            font-weight: bold;
        }

        .score-track {
            width: 100%;
            height: 6px;
            background: #1a1a1a;
            border: 1px solid #333;
            position: relative;
        }

        .score-fill {
            height: 100%;
            background: var(--text-primary);
            transition: width 1s cubic-bezier(0.22, 1, 0.36, 1);
        }

        /* Continue Button */
        .continue-btn {
            width: 100%;
            background: var(--text-primary);
            border: 1px solid var(--text-primary);
            color: var(--bg-color);
            padding: 1rem;
            font-family: var(--font-mono);
            font-size: 0.9rem;
            font-weight: 700;
            cursor: pointer;
            text-transform: uppercase;
            transition: all 0.2s;
            margin-top: 2rem;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
        }

        .continue-btn:hover {
            background: #fff;
            box-shadow: 0 0 15px rgba(255, 255, 255, 0.3);
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 4px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-color);
        }

        ::-webkit-scrollbar-thumb {
            background: #333;
        }
    </style>
</head>

<body>

    <div class="progress-bar-container">
        <div class="progress-bar" id="progress-bar" style="width: 0%"></div>
    </div>

    <div class="container">
        <!-- Question View -->
        <div id="question-view">
            <div class="question-meta">
                <span id="question-counter">INITIALIZING...</span>
            </div>

            <div class="question-text" id="question-text"></div>

            <div class="input-group">
                <div class="input-rect" onclick="handleInput(1)" data-val="1">
                    <div class="dot" style="background-color: var(--val-1);"></div>
                </div>
                <div class="input-rect" onclick="handleInput(2)" data-val="2">
                    <div class="dot" style="background-color: var(--val-2);"></div>
                </div>
                <div class="input-rect" onclick="handleInput(3)" data-val="3">
                    <div class="dot" style="background-color: var(--val-3);"></div>
                </div>
                <div class="input-rect" onclick="handleInput(4)" data-val="4">
                    <div class="dot" style="background-color: var(--val-4);"></div>
                </div>
                <div class="input-rect" onclick="handleInput(5)" data-val="5">
                    <div class="dot" style="background-color: var(--val-5);"></div>
                </div>
            </div>

            <div class="nav-controls">
                <button class="nav-btn" id="back-btn" onclick="prevQuestion()" style="visibility: hidden;">[ PREV
                    ]</button>
                <button class="nav-btn jump-btn" id="jump-btn" onclick="jumpToFurthest()" style="display: none;">[
                    RETURN ]</button>
            </div>
        </div>

        <!-- Results View -->
        <div id="results-view">
            <div class="results-container">

                <!-- Header -->
                <div class="result-header">
                    <div class="designation-label">Your Designation</div>
                    <div class="archetype-code" id="archetype-code">CALCULATING</div>
                    <div class="archetype-detailed" id="archetype-detailed" onclick="toggleSloanInfo()">[ EXPAND
                        DESIGNATION ANALYSIS ]</div>

                    <div id="sloan-info">
                        <div class="info-grid">
                            <!-- Left Column: User Specifics -->
                            <div class="info-column">
                                <p>Your Configuration</p>
                                <div id="complex-code-display"></div>
                                <ul class="user-breakdown-list" id="user-breakdown">
                                    <!-- Populated via JS -->
                                </ul>
                            </div>

                            <!-- Right Column: Legend -->
                            <div class="info-column">
                                <p>Reference Key</p>

                                <div style="font-size: 0.7rem; color: #888; margin-bottom: 10px; line-height: 1.4;">
                                    <strong>Intensity Modifiers</strong> denote how far each trait deviates from
                                    neutral (50). The letter indicates direction; the number indicates strength.<br><br>
                                    <strong>Structural Match</strong> (the final symbol) analyzes the
                                    <strong>definition</strong> and <strong>symmetry</strong> of your profile. It
                                    indicates whether your archetype is driven by uniform traits (Balanced) or specific
                                    dominant spikes (Asymmetric).
                                </div>

                                <!-- Intensity Table (Distance from 50) -->
                                <table class="legend-table">
                                    <tr>
                                        <td class="sym">⁹ ⁸</td>
                                        <td>[Extremely]</td>
                                        <td>40–50 from neutral</td>
                                    </tr>
                                    <tr>
                                        <td class="sym">⁷ ⁶</td>
                                        <td>[Very]</td>
                                        <td>30–39 from neutral</td>
                                    </tr>
                                    <tr>
                                        <td class="sym">⁵ ⁴</td>
                                        <td>[Moderately]</td>
                                        <td>20–29 from neutral</td>
                                    </tr>
                                    <tr>
                                        <td class="sym">³ ²</td>
                                        <td>[Vaguely]</td>
                                        <td>10–19 from neutral</td>
                                    </tr>
                                    <tr>
                                        <td class="sym">¹ ⁰</td>
                                        <td>[Neutral / Balanced]</td>
                                        <td>0–9 from neutral</td>
                                    </tr>
                                </table>

                                <!-- Structure Table -->
                                <table class="legend-table">
                                    <tr>
                                        <th colspan="3"
                                            style="border:none; padding-bottom:5px; color:#aaa; font-weight:normal;">
                                            Structural Match Strength</th>
                                    </tr>
                                    <tr>
                                        <td class="sym">◈</td>
                                        <td>True Neutral</td>
                                        <td>Perfectly Balanced</td>
                                    </tr>
                                    <tr>
                                        <td class="sym">▾</td>
                                        <td>Strong Match</td>
                                        <td>Balanced Profile</td>
                                    </tr>
                                    <tr>
                                        <td class="sym">▿</td>
                                        <td>Strong Match</td>
                                        <td>Uneven Profile</td>
                                    </tr>
                                    <tr>
                                        <td class="sym">●</td>
                                        <td>Good Match</td>
                                        <td>Balanced Profile</td>
                                    </tr>
                                    <tr>
                                        <td class="sym">⚬</td>
                                        <td>Good Match</td>
                                        <td>Uneven Profile</td>
                                    </tr>
                                    <tr>
                                        <td class="sym">￭</td>
                                        <td>Weak Match</td>
                                        <td>Balanced Profile</td>
                                    </tr>
                                    <tr>
                                        <td class="sym">⌑</td>
                                        <td>Weak Match</td>
                                        <td>Uneven Profile</td>
                                    </tr>
                                </table>
                            </div>


                        </div>
                    </div>

                    <div class="archetype-summary" id="archetype-summary"></div>
                </div>

                <button class="continue-btn" onclick="redirectToForm()">
                    [ CONTINUE TO FORM ]
                </button>

                <!-- Data Grid -->
                <div class="data-grid">
                    <!-- Visual -->
                    <div>
                        <div class="score-section-title">Metric Visualization</div>
                        <div class="chart-wrapper">
                            <canvas id="oceanCanvas"></canvas>
                        </div>
                    </div>

                    <!-- Scores -->
                    <div>
                        <div class="score-section-title">Component Analysis</div>
                        <div id="big5-scores"></div>

                        <div class="score-section-title" style="margin-top: 2rem;">Dark Triad Indices</div>
                        <div id="dt-scores"></div>
                    </div>
                </div>


            </div>
        </div>
    </div>

    <script>
        // ---------------- DATA STRUCTURE ----------------
        const QUESTIONS = [
            // --- OPENNESS (10 Items) ---
            // Measures: intellectual curiosity, imagination, aesthetic sensitivity, preference for novelty
            { id: 17, text: "I enjoy discussing abstract ideas even when they have no immediate practical use.", trait: "Openness", reverse: false },
            { id: 18, text: "I have a vivid imagination.", trait: "Openness", reverse: false },
            { id: 19, text: "I get very absorbed in art, music, nature, or books.", trait: "Openness", reverse: false },
            { id: 20, text: "I enjoy exploring ideas that challenge how I see the world.", trait: "Openness", reverse: true },
            { id: 21, text: "I try new experiences just to see what they’re like.", trait: "Openness", reverse: false },
            { id: 22, text: "I prefer sticking to what I know, rather than learning new things.", trait: "Openness", reverse: true },
            { id: 23, text: "I enjoy experimenting with new ways of thinking or doing things.", trait: "Openness", reverse: false },
            { id: 24, text: "I am curious about topics outside my usual interests.", trait: "Openness", reverse: false },
            { id: 59, text: "I find it uncomfortable when ideas are complex or hard to understand.", trait: "Openness", reverse: false },
            { id: 60, text: "I am someone who tries unconventional approaches to problems.", trait: "Openness", reverse: false },

            // --- CONSCIENTIOUSNESS (10 Items) ---
            // Measures: organization, self-discipline, reliability, planning
            { id: 33, text: "A disordered workspace makes it harder for me to focus.", trait: "Conscientiousness", reverse: false },
            { id: 34, text: "Deadlines should be negotiable and flexible in practice rather than strict.", trait: "Conscientiousness", reverse: true },
            { id: 35, text: "I prefer having a structured routine rather than improvising each day.", trait: "Conscientiousness", reverse: false },
            { id: 36, text: "I don't worry much about small details when working on a long-term goal.", trait: "Conscientiousness", reverse: true },
            { id: 37, text: "I set high standards for the quality of my work.", trait: "Conscientiousness", reverse: false },
            { id: 38, text: "I prepare for potential setbacks in advance.", trait: "Conscientiousness", reverse: false },
            { id: 39, text: "When I start a task, I make sure I have everything I need to finish it.", trait: "Conscientiousness", reverse: false },
            { id: 40, text: "I complete important tasks even when I don’t feel like it.", trait: "Conscientiousness", reverse: false },
            { id: 53, text: "I track progress whenever possible.", trait: "Conscientiousness", reverse: false },
            { id: 54, text: "I tend to leave things unfinished.", trait: "Conscientiousness", reverse: true },

            // --- EXTRAVERSION (10 Items) ---
            // Measures: sociability, assertiveness, positive affect, activity
            { id: 9, text: "I need time alone to recharge after social activity.", trait: "Extraversion", reverse: true },       // revised to focus on preference
            { id: 10, text: "I prefer to stay in the background rather than lead the discussion.", trait: "Extraversion", reverse: true },
            { id: 12, text: "I avoid social gatherings unless I have a clear reason to attend.", trait: "Extraversion", reverse: true },
            { id: 14, text: "I try not to draw attention to myself in groups.", trait: "Extraversion", reverse: true },
            { id: 16, text: "I prefer calm social settings (small groups, quiet conversations) over loud parties.", trait: "Extraversion", reverse: true }, // fixes openness confound
            { id: 11, text: "I like to keep my social schedule full and active.", trait: "Extraversion", reverse: false },
            { id: 13, text: "Being around lively, energetic people boosts my mood.", trait: "Extraversion", reverse: false },   // adds affect
            { id: 15, text: "I seek out invitations and opportunities to socialize.", trait: "Extraversion", reverse: false }, // rewrites 'wish' to measure approach
            { id: 61, text: "I can easily start conversations with strangers.", trait: "Extraversion", reverse: false },
            { id: 62, text: "I like taking the lead when a group needs direction.", trait: "Extraversion", reverse: false },      // added assertivenes
            // --- AGREEABLENESS (10 Items) ---
            // Measures: trust, compassion, cooperation, concern for others
            { id: 25, text: "I assume most people are trustworthy until proven otherwise.", trait: "Agreeableness", reverse: false },
            { id: 26, text: "Being direct and forceful is often more effective than being gentle.", trait: "Agreeableness", reverse: true },
            { id: 27, text: "If my goals conflict with the group’s, I usually choose my own.", trait: "Agreeableness", reverse: true },
            { id: 28, text: "I try to understand other people’s feelings before judging them.", trait: "Agreeableness", reverse: false },
            { id: 29, text: "I can be quite blunt and harsh in disputes.", trait: "Agreeableness", reverse: true },
            { id: 30, text: "I am concerned about how my decisions affect others.", trait: "Agreeableness", reverse: false },
            { id: 31, text: "I help strangers whenever I can.", trait: "Agreeableness", reverse: false },
            { id: 32, text: "I rarely forgive people more than once.", trait: "Agreeableness", reverse: true },
            { id: 63, text: "A cooperative approach often produces better long-term outcomes than purely competitive ones.", trait: "Agreeableness", reverse: false },
            { id: 64, text: "I am willing to compromise on disagreements.", trait: "Agreeableness", reverse: false },

            // --- NEUROTICISM (10 Items) ---
            // Measures: emotional reactivity, anxiety, mood variability, vulnerability to stress
            { id: 1, text: "I notice stress signals in my body a lot.", trait: "Neuroticism", reverse: false },
            { id: 2, text: "I take criticism more personally than I’d like to.", trait: "Neuroticism", reverse: true },
            { id: 3, text: "I can't help but dwell on my mistakes.", trait: "Neuroticism", reverse: false },
            { id: 4, text: "I feel tense or on edge more often than others seem to.", trait: "Neuroticism", reverse: true },
            { id: 5, text: "I remain calm even in stressful situations.", trait: "Neuroticism", reverse: false },
            { id: 6, text: "Worrying about my problems won't help me solve them, so I don't worry much about them.", trait: "Neuroticism", reverse: true },
            { id: 7, text: "The unpredictable nature of the world makes me uneasy.", trait: "Neuroticism", reverse: false },
            { id: 8, text: "I bounce back quickly after setbacks.", trait: "Neuroticism", reverse: true },
            { id: 57, text: "I sometimes overthink situations long after they are over.", trait: "Neuroticism", reverse: false },
            { id: 58, text: "I rarely panic in stressful situations.", trait: "Neuroticism", reverse: true },

            // --- DARK TRIAD (12 Items) ---
            // Measures: Machiavellianism (41-44), Psychopathy (45-48), Narcissism (49-52)

            // Machiavellianism: strategic manipulation, instrumental honesty
            { id: 41, text: "It’s smart to keep your true intentions hidden.", trait: "Machiavellianism", reverse: false },
            { id: 42, text: "I would prefer to be respected rather than liked in a leadership role.", trait: "Machiavellianism", reverse: false },
            { id: 43, text: "People’s public morals are often a performance.", trait: "Machiavellianism", reverse: false },
            { id: 44, text: "In negotiations, I prefer approaches that maximize outcome even if they seem cold.", trait: "Machiavellianism", reverse: false },
            // Psychopathy: low empathy, impulsivity, risk-taking
            { id: 45, text: "I seldom feel guilty after upsetting someone.", trait: "Psychopathy", reverse: false },
            { id: 46, text: "I generally follow social rules even when they are inconvenient.", trait: "Psychopathy", reverse: true },
            { id: 47, text: "I take risks that others would describe as reckless when the reward seems worth it.", trait: "Psychopathy", reverse: false },
            { id: 48, text: "The suffering of others rarely influences my decisions.", trait: "Psychopathy", reverse: false },
            // Narcissism: grandiosity, entitlement, need for admiration
            { id: 49, text: "I see myself as more capable than most people I know.", trait: "Narcissism", reverse: false },
            { id: 50, text: "I prefer leadership roles because I think I perform better than most followers.", trait: "Narcissism", reverse: false },
            { id: 51, text: "Recognition for my achievements is important to my sense of self-worth.", trait: "Narcissism", reverse: false },
            { id: 52, text: "I usually expect special treatment when I deserve it.", trait: "Narcissism", reverse: false }
        ];


        // ---------------- LOGIC ----------------
        let currentQIndex = 0;
        let furthestQIndex = 0;
        const answers = new Array(QUESTIONS.length).fill(null);

        function applyBionic(text) {
            return text.split(' ').map(word => {
                const splitIndex = Math.ceil(word.length / 2);
                const boldPart = word.substring(0, splitIndex);
                const normalPart = word.substring(splitIndex);
                return `<span class="bionic-bold">${boldPart}</span>${normalPart}`;
            }).join(' ');
        }

        function renderQuestion() {
            if (currentQIndex >= QUESTIONS.length) {
                showResults();
                return;
            }

            // Update Furthest
            if (currentQIndex > furthestQIndex) furthestQIndex = currentQIndex;

            const q = QUESTIONS[currentQIndex];
            const container = document.getElementById('question-text');
            container.innerHTML = applyBionic(q.text);

            // Progress
            const progress = (currentQIndex / QUESTIONS.length) * 100;
            document.getElementById('progress-bar').style.width = `${progress}%`;
            document.getElementById('question-counter').innerText = `ITEM ${currentQIndex + 1} / ${QUESTIONS.length}`;

            // Nav Buttons
            document.getElementById('back-btn').style.visibility = currentQIndex > 0 ? 'visible' : 'hidden';

            // Jump Button Logic
            const jumpBtn = document.getElementById('jump-btn');
            if (currentQIndex < furthestQIndex) {
                jumpBtn.style.display = 'block';
                jumpBtn.innerText = `[ RETURN TO ${furthestQIndex + 1} ]`;
            } else {
                jumpBtn.style.display = 'none';
            }

            // Highlight Selected Answer
            document.querySelectorAll('.input-rect').forEach(el => {
                el.classList.remove('selected');
                if (answers[currentQIndex] !== null && parseInt(el.dataset.val) === answers[currentQIndex]) {
                    el.classList.add('selected');
                }
            });
        }

        function handleInput(val) {
            answers[currentQIndex] = val;
            currentQIndex++;
            renderQuestion();
        }

        function prevQuestion() {
            if (currentQIndex > 0) {
                currentQIndex--;
                renderQuestion();
            }
        }

        function jumpToFurthest() {
            currentQIndex = furthestQIndex;
            renderQuestion();
        }

        // ---------------- ADVANCED METRICS ----------------
        function getTraitSymbol(score) {
            // Superscript Intensity: 0-9 based on distance from neutral (50)
            // Direction is handled by the letter (O/U, S/R, etc.)
            // Number always means strength/extremity
            const superscripts = ["⁰", "¹", "²", "³", "⁴", "⁵", "⁶", "⁷", "⁸", "⁹"];

            // Distance from neutral (0-50) mapped to index 0-9
            // Each bucket spans 5 points of distance:
            //   ⁰ = 0-4, ¹ = 5-9, ² = 10-14, ³ = 15-19,
            //   ⁴ = 20-24, ⁵ = 25-29, ⁶ = 30-34, ⁷ = 35-39,
            //   ⁸ = 40-44, ⁹ = 45-50
            const distance = Math.abs(score - 50);
            let idx = Math.floor(distance / 5);
            if (idx > 9) idx = 9;
            if (idx < 0) idx = 0;

            return superscripts[idx];
        }

        function calculateStructure(normalized) {
            const traits = ["Openness", "Conscientiousness", "Extraversion", "Agreeableness", "Neuroticism"];

            // 1. Calculate Deviations
            const deviations = traits.map(t => Math.abs(normalized[t] - 50));

            // 2. Sort Deviations (Highest to Lowest)
            const sortedDevs = [...deviations].sort((a, b) => b - a);

            // 3. Calculate "Cardinal Strength" (Average of the Top 3 only)
            // This prevents neutral traits from dragging down the score of spiky profiles.
            const cardinalStrength = (sortedDevs[0] + sortedDevs[1] + sortedDevs[2]) / 3;

            // 4. Calculate Consistency (PSI) - Standard Deviation of all 5
            // We still use all 5 here because we want to know if the profile is "Lopsided" (High PSI) or "Even" (Low PSI)
            const meanDev = deviations.reduce((a, b) => a + b, 0) / 5;
            const variance = deviations.reduce((a, b) => a + Math.pow(b - meanDev, 2), 0) / 5;
            const psi = Math.sqrt(variance);

            // --- LOGIC GATES ---

            // True Neutral: If your *strongest* traits are still weak.
            if (cardinalStrength < 12 && psi < 8) {
                return "◈"; // True Neutral
            }

            // Strength Thresholds (Adjusted for Top 3 logic)
            // > 24: Strong (Avg score of top 3 is >74 or <26)
            // > 14: Good   (Avg score of top 3 is >64 or <36)
            // < 14: Weak   (Messy profile)
            let strength = "";
            if (cardinalStrength >= 24) strength = "Strong";
            else if (cardinalStrength >= 14) strength = "Fair";
            else strength = "Weak";

            // Symmetry Threshold
            // High PSI (>10) means you are "Spiky" (Some high, some low)
            // Low PSI (<10) means you are "Flat" (All scores roughly same distance from center)
            let symmetry = (psi < 10) ? "Even" : "Odd";

            // Return Symbol
            if (strength === "Strong" && symmetry === "Even") return "▾"; // Strong Balanced
            if (strength === "Strong" && symmetry === "Odd") return "▿";  // Strong Spiky
            if (strength === "Fair" && symmetry === "Even") return "●";   // Good Balanced
            if (strength === "Fair" && symmetry === "Odd") return "⚬";    // Good Spiky
            if (strength === "Weak" && symmetry === "Even") return "￭";   // Weak Balanced
            return "⌑"; // Weak Spiky
        }

        // SLOAN Definitions
        const sloanDefs = {
            "S": { name: "Social", desc: "High Extraversion" },
            "R": { name: "Reserved", desc: "Low Extraversion" },
            "L": { name: "Limbic", desc: "High Neuroticism" },
            "C": { name: "Calm", desc: "Low Neuroticism" },
            "O": { name: "Organized", desc: "High Conscientiousness" },
            "U": { name: "Unstructured", desc: "Low Conscientiousness" },
            "A": { name: "Accommodating", desc: "High Agreeableness" },
            "E": { name: "Egocentric", desc: "Low Agreeableness" },
            "I": { name: "Inquisitive", desc: "High Openness" },
            "N": { name: "Non-curious", desc: "Low Openness" }
        };

        function showResults() {
            document.getElementById('question-view').style.display = 'none';
            document.getElementById('results-view').style.display = 'block';
            document.getElementById('progress-bar').style.width = '100%';

            const scores = calculateScores();
            const normalized = scores.normalized;

            // GENERATE SLOAN CODE
            let simpleCode = "";
            let complexCode = "";
            let traits = {};
            let userBreakdownHTML = "";

            const mapTrait = (traitName, highChar, lowChar) => {
                const val = normalized[traitName];
                const sym = getTraitSymbol(val);

                // Intensity index based on distance from 50
                const distance = Math.abs(val - 50);
                let idx = Math.floor(distance / 5);
                if (idx > 9) idx = 9;
                if (idx < 0) idx = 0;

                let char = "";
                let isPerfectBalance = false;

                if (Math.round(val) === 50) {
                    char = "x";
                    isPerfectBalance = true;
                } else if (val > 50) {
                    char = highChar;
                    traits[highChar] = true;
                } else {
                    char = lowChar;
                    traits[lowChar] = true;
                }

                simpleCode += char;
                complexCode += char + sym;

                // Build Breakdown HTML
                // Bracket labels based on intensity pairs:
                //   0-1 = Neutral / Balanced
                //   2-3 = Vaguely
                //   4-5 = Moderately
                //   6-7 = Very
                //   8-9 = Extremely
                let description = "";
                let name = "";

                if (isPerfectBalance) {
                    name = "Balanced";
                    description = `Perfectly Balanced ${traitName}`;
                } else {
                    const def = sloanDefs[char];
                    name = def.name;

                    if (idx <= 1) {
                        description = `Balanced ${traitName}`;
                    } else if (idx <= 3) {
                        description = `Vaguely ${def.name}`;
                    } else if (idx <= 5) {
                        description = `Moderately ${def.name}`;
                    } else if (idx <= 7) {
                        description = `Very ${def.name}`;
                    } else {
                        description = `Extremely ${def.name}`;
                    }
                }

                userBreakdownHTML += `
                    <li>
                        <span class="ub-letter">${char}${sym} &nbsp; ${name}</span>
                        <span class="ub-desc">${description}</span>
                    </li>
                `;
            };

            mapTrait("Extraversion", "S", "R");
            mapTrait("Neuroticism", "L", "C");
            mapTrait("Conscientiousness", "O", "U");
            mapTrait("Agreeableness", "A", "E");
            mapTrait("Openness", "I", "N");

            const structSymbol = calculateStructure(normalized);

            // Main Display: Simple Code + Symbol (e.g. RLUAI●)
            document.getElementById('archetype-code').innerText = simpleCode + structSymbol;

            // Expanded Display: Complex Code + Symbol (e.g. R⎽L˖U⎺A₊I˖●)
            document.getElementById('complex-code-display').innerText = complexCode + structSymbol;

            document.getElementById('user-breakdown').innerHTML = userBreakdownHTML;
            document.getElementById('archetype-summary').innerHTML = generateDescription(normalized);

            // Wait for layout to settle before drawing canvas
            setTimeout(() => {
                drawPentagon(normalized);
            }, 100);

            // Render Bars
            const big5HTML = ["Openness", "Conscientiousness", "Extraversion", "Agreeableness", "Neuroticism"]
                .map(t => renderScoreRow(t, normalized[t])).join('');
            document.getElementById('big5-scores').innerHTML = big5HTML;

            const dtHTML = ["Machiavellianism", "Narcissism", "Psychopathy"]
                .map(t => renderScoreRow(t, normalized[t])).join('');
            document.getElementById('dt-scores').innerHTML = dtHTML;
        }

        // ---------------- TEXT GENERATION ENGINE ----------------

        const traitText = {
            "Extraversion": {
                high: "a drive for external stimulus and social engagement",
                low: "a distinct preference for solitary processing and environmental shielding",
                mid: "a flexible social battery that adapts to context"
            },
            "Neuroticism": {
                high: "heightened sensitivity to environmental instability and threat detection",
                low: "robust emotional equilibrium and resistance to stress",
                mid: "generally stable emotional regulation with situational reactivity"
            },
            "Conscientiousness": {
                high: "a rigorous adherence to structure, planning, and efficiency",
                low: "a preference for spontaneity and flexible improvisation over rigid planning",
                mid: "a balanced workflow that alternates between structure and adaptability"
            },
            "Agreeableness": {
                high: "a cooperative instinct that prioritizes group cohesion",
                low: "a competitive, skeptical stance focused on leverage and outcome",
                mid: "a transactional approach to cooperation based on mutual benefit"
            },
            "Openness": {
                high: "a cognitive framework prioritizing novelty, abstraction, and theory",
                low: "a pragmatic focus on established methods, concrete data, and utility",
                mid: "a balance between theoretical curiosity and practical application"
            }
        };

        function generateDescription(scores) {
            // 1. Calculate deviations to find the "Driver" traits
            const traits = Object.keys(scores).filter(k => k !== "Machiavellianism" && k !== "Narcissism" && k !== "Psychopathy");

            const ranked = traits.map(t => {
                const val = scores[t];
                const dev = Math.abs(val - 50);
                let intensity = "mid";
                if (val >= 65) intensity = "high";
                else if (val <= 35) intensity = "low";

                // "Extreme" flag for very high deviations
                const isExtreme = dev >= 25;

                return { trait: t, val, dev, intensity, isExtreme };
            }).sort((a, b) => b.dev - a.dev); // Sort highest deviation first

            // 2. Construct the Narrative
            let desc = "";

            // --- PART A: The Primary Driver (The #1 most distinct trait) ---
            const primary = ranked[0];
            desc += `Your behavioral architecture is primarily defined by <strong>${traitText[primary.trait][primary.intensity]}</strong>. `;

            // --- PART B: The Supporting Structure (Traits 2 and 3) ---
            // We combine these to show how they interact with the primary.
            const secondary = ranked[1];
            const tertiary = ranked[2];

            desc += `This configuration is reinforced by ${traitText[secondary.trait][secondary.intensity]}, `;
            desc += `while maintaining ${traitText[tertiary.trait][tertiary.intensity]}. `;

            // --- PART C: The Stabilizers (The Neutral/Lowest Deviation traits) ---
            // If the bottom traits are actually neutral (dev < 15), we frame them as "Stabilizers".
            // If they are still spiky (just less spiky than the top), we frame them as "Additional factors".
            const bottom = ranked.slice(3);
            const neutrals = bottom.filter(x => x.dev < 20); // slightly relaxed from 15

            if (neutrals.length > 0) {
                const names = neutrals.map(x => x.trait).join(" and ");
                desc += `Notably, your scores in ${names} indicate a <strong>stabilizing versatility</strong>, allowing you to adapt your approach in these areas depending on the specific demands of the situation.`;
            } else {
                // If even the bottom traits are extreme (a very intense personality)
                desc += `Finally, the profile is completed by ${traitText[bottom[0].trait][bottom[0].intensity]}.`;
            }

            return desc;
        }

        function renderScoreRow(trait, score) {
            return `
            <div class="score-block">
                <div class="score-header">
                    <span class="score-name">${trait}</span>
                    <span class="score-val">${Math.round(score)}%</span>
                </div>
                <div class="score-track">
                    <div class="score-fill" style="width: ${score}%"></div>
                </div>
            </div>
        `;
        }

        function calculateScores() {
            const raw = {
                "Neuroticism": 0, "Extraversion": 0, "Openness": 0, "Agreeableness": 0, "Conscientiousness": 0,
                "Machiavellianism": 0, "Psychopathy": 0, "Narcissism": 0
            };
            const counts = {
                "Neuroticism": 0, "Extraversion": 0, "Openness": 0, "Agreeableness": 0, "Conscientiousness": 0,
                "Machiavellianism": 0, "Psychopathy": 0, "Narcissism": 0
            };

            QUESTIONS.forEach((q, i) => {
                if (raw[q.trait] !== undefined) {
                    let val = answers[i];
                    if (val === null || val === undefined) val = 3;
                    if (q.reverse) val = 6 - val;
                    raw[q.trait] += val;
                    counts[q.trait]++;
                }
            });

            const normalized = {};

            // ──────────────────────────────────────────────────────────
            // DARK TRIAD CALIBRATION
            // ──────────────────────────────────────────────────────────
            // Each DT trait's questions have different "difficulty" levels
            // due to social desirability framing. An average person responds
            // differently to each set:
            //
            //   Machiavellianism: Items sound pragmatic/rational, so average
            //     people tend to agree (~3.6/5). expectedMean = 14.5 out of 20.
            //
            //   Psychopathy: Items are more confrontational, so average people
            //     tend to mildly disagree (~2.4/5). expectedMean = 9.5 out of 20.
            //
            //   Narcissism: Moderate difficulty. Average people are near neutral
            //     but lean slightly agree (~3.25/5). expectedMean = 13 out of 20.
            //
            // We use piecewise linear normalization so that each trait's
            // expected average raw score maps to exactly 50, while 
            // preserving 0 at minimum and 100 at maximum.
            // ──────────────────────────────────────────────────────────
            const dtCalibration = {
                "Machiavellianism": 14.5,
                "Psychopathy": 9.5,
                "Narcissism": 13
            };

            for (let t in raw) {
                const count = counts[t];
                if (count === 0) {
                    normalized[t] = 0;
                    continue;
                }

                const minRaw = count;         // All 1s
                const maxRaw = count * 5;     // All 5s

                if (dtCalibration[t] !== undefined) {
                    // Piecewise linear: expectedMean → 50
                    const em = dtCalibration[t];
                    if (raw[t] <= em) {
                        normalized[t] = ((raw[t] - minRaw) / (em - minRaw)) * 50;
                    } else {
                        normalized[t] = 50 + ((raw[t] - em) / (maxRaw - em)) * 50;
                    }
                } else {
                    // Big Five: standard linear 0-100
                    normalized[t] = ((raw[t] - minRaw) / (maxRaw - minRaw)) * 100;
                }

                normalized[t] = Math.max(0, Math.min(100, normalized[t]));
            }

            return { raw, normalized };
        }

        function redirectToForm() {
            const scores = calculateScores().normalized;

            // Updated Google Form Entry IDs for the new form
            const entryIDs = {
                "Openness": "402402723",
                "Conscientiousness": "838876990",
                "Extraversion": "1893620745", // Form uses "Extroversion Score"
                "Agreeableness": "58068965",
                "Neuroticism": "1629665739", // Form uses "Neurotic Score "
                "Machiavellianism": "861532553",
                "Narcissism": "561194856",
                "Psychopathy": "1829528666"
            };

            const baseUrl = "https://docs.google.com/forms/d/e/1FAIpQLSflZH458ErTYrYEgi5fydaHFw6AydMiRebzE7jBoShxRWgMig/viewform?usp=pp_url";

            let params = "";
            for (const [trait, id] of Object.entries(entryIDs)) {

                const val = Math.round(scores[trait] || 0);
                params += `&entry.${id}=${val}`;
            }

            window.location.href = baseUrl + params;
        }

        function drawPentagon(normalizedScores) {
            const canvas = document.getElementById('oceanCanvas');
            const container = canvas.parentElement;

            // Handle High DPI
            const dpr = window.devicePixelRatio || 1;
            const rect = container.getBoundingClientRect();

            canvas.width = rect.width * dpr;
            canvas.height = rect.width * dpr; // Square aspect ratio

            const ctx = canvas.getContext('2d');
            ctx.scale(dpr, dpr);

            const width = rect.width;
            const height = rect.width;
            const cx = width / 2;
            const cy = height / 2;
            const r = (width / 2) - 30; // Padding

            ctx.clearRect(0, 0, width, height);

            // Axes
            const axes = [
                { label: "O", angle: -Math.PI / 2, val: normalizedScores["Openness"], color: "#38bdf8" },
                { label: "C", angle: -Math.PI / 2 + (2 * Math.PI / 5), val: normalizedScores["Conscientiousness"], color: "#fbbf24" },
                { label: "E", angle: -Math.PI / 2 + 2 * (2 * Math.PI / 5), val: normalizedScores["Extraversion"], color: "#f87171" },
                { label: "A", angle: -Math.PI / 2 + 3 * (2 * Math.PI / 5), val: normalizedScores["Agreeableness"], color: "#4ade80" },
                { label: "N", angle: -Math.PI / 2 + 4 * (2 * Math.PI / 5), val: normalizedScores["Neuroticism"], color: "#a78bfa" }
            ];

            // Grid
            ctx.strokeStyle = '#333';
            ctx.lineWidth = 1;
            [0.2, 0.4, 0.6, 0.8, 1].forEach(scale => {
                ctx.beginPath();
                axes.forEach((axis, i) => {
                    const x = cx + Math.cos(axis.angle) * r * scale;
                    const y = cy + Math.sin(axis.angle) * r * scale;
                    i === 0 ? ctx.moveTo(x, y) : ctx.lineTo(x, y);
                });
                ctx.closePath();
                ctx.stroke();
            });

            // Data Shape
            ctx.beginPath();
            ctx.fillStyle = 'rgba(255, 255, 255, 0.08)';
            ctx.strokeStyle = '#fff';
            ctx.lineWidth = 2;
            axes.forEach((axis, i) => {
                const val = axis.val || 0;
                const dist = (val / 100) * r;
                const x = cx + Math.cos(axis.angle) * dist;
                const y = cy + Math.sin(axis.angle) * dist;
                i === 0 ? ctx.moveTo(x, y) : ctx.lineTo(x, y);
            });
            ctx.closePath();
            ctx.fill();
            ctx.stroke();

            // Draw Points & Labels
            ctx.font = 'bold 12px JetBrains Mono';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';

            axes.forEach(axis => {
                const val = axis.val || 0;
                const dist = (val / 100) * r;
                const x = cx + Math.cos(axis.angle) * dist;
                const y = cy + Math.sin(axis.angle) * dist;

                // Point
                ctx.beginPath();
                ctx.arc(x, y, 4, 0, 2 * Math.PI);
                ctx.fillStyle = axis.color;
                ctx.fill();
                ctx.strokeStyle = '#000';
                ctx.lineWidth = 1;
                ctx.stroke();

                // Label
                const lx = cx + Math.cos(axis.angle) * (r + 20);
                const ly = cy + Math.sin(axis.angle) * (r + 20);
                ctx.fillStyle = axis.color;
                ctx.fillText(axis.label, lx, ly);
            });
        }

        function toggleSloanInfo() {
            const el = document.getElementById('sloan-info');
            const btn = document.getElementById('archetype-detailed');

            if (el.style.display === 'block') {
                el.style.display = 'none';
                btn.innerText = "[ EXPAND DESIGNATION ANALYSIS ]";
            } else {
                el.style.display = 'block';
                btn.innerText = "[ COLLAPSE ANALYSIS ]";
            }
        }

        // Init
        renderQuestion();

        // Handle Resize for Canvas
        window.addEventListener('resize', () => {
            if (document.getElementById('results-view').style.display === 'block') {
                const scores = calculateScores();
                drawPentagon(scores.normalized);
            }
        });
    </script>
</body>

</html>
